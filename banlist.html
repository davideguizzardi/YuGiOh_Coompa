<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Banlist Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body class="dark:bg-gray-800 dark:text-zinc-100 bg-gray-100 p-2 flex flex-col">
    <header class="mb-4 dark:bg-gray-700 bg-white p-2 rounded">
        <h1 id="banlistTitle" class="text-2xl font-semibold mb-2">Banlist Viewer</h1>
    </header>

    <div class="flex flex-col lg:flex-row gap-6">
        <div id="cardGrid"
            class="dark-scrollbar lg:order-1 order-2 lg:w-2/3 overflow-auto h-[80vh] rounded p-2 space-y-6 dark:bg-gray-700 bg-white">
        </div>

        <div id="cardDetails"
            class="dark-scrollbar lg:order-2 order-1 flex flex-col dark:bg-gray-700 bg-white rounded shadow p-4 overflow-auto lg:w-1/3">
            <p class="text-gray-500 italic">Select a card to see details.</p>
        </div>
    </div>

    <script>
        let allCardsData = {};
        let altIdToMainCard = {};
        const banNames = { 0: "Forbidden", 1: "Limited", 2: "Semi-Limited" };

        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        async function loadAllCards() {
            const res = await fetch('all_cards.json');
            allCardsData = await res.json();
            for (const [mainId, card] of Object.entries(allCardsData)) {
                (card.card_images || []).forEach(altId => altIdToMainCard[altId] = card);
                altIdToMainCard[mainId] = card;
            }
        }

        // Define card type priority in custom order
        const TYPE_PRIORITY = {
            "Normal Monster": 1,
            "Effect Monster": 2,
            "Ritual Monster": 3,
            "Fusion Monster": 4,
            "Synchro Monster": 5,
            "XYZ Monster": 6,
            "Link Monster": 7,
            "Spell Card": 8,
            "Trap Card": 9
        };

        // Infer priority from type string
        function getTypePriority(type) {
            if (!type) return 99;
            const typeStr = type.toLowerCase();

            if (typeStr.includes("normal")) return TYPE_PRIORITY["Normal Monster"];
            if (typeStr.includes("ritual")) return TYPE_PRIORITY["Ritual Monster"];
            if (typeStr.includes("fusion")) return TYPE_PRIORITY["Fusion Monster"];
            if (typeStr.includes("synchro")) return TYPE_PRIORITY["Synchro Monster"];
            if (typeStr.includes("xyz")) return TYPE_PRIORITY["XYZ Monster"];
            if (typeStr.includes("link")) return TYPE_PRIORITY["Link Monster"];
            if (typeStr.includes("spell")) return TYPE_PRIORITY["Spell Card"];
            if (typeStr.includes("trap")) return TYPE_PRIORITY["Trap Card"];
            if (typeStr.includes("effect monster")) return TYPE_PRIORITY["Effect Monster"];
            if (typeStr.includes("tuner")) return TYPE_PRIORITY["Effect Monster"];

            return 99;
        }


        // Sort cards by type priority and then by name
        function sortCards(cards) {
            return cards.slice().sort((a, b) => {
                const priA = getTypePriority(a.type);
                const priB = getTypePriority(b.type);
                if (priA !== priB) return priA - priB;
                return (a.name ?? "").localeCompare(b.name ?? "");
            });
        }

        async function loadBanlist() {
            const format = getQueryParam('format') || 'current';
            document.getElementById('banlistTitle').textContent = `Banlist: ${format}`;
            const res = await fetch('banlist.json');
            const banlist = await res.json();
            const cardsByStatus = banlist;

            const grid = document.getElementById('cardGrid');
            grid.innerHTML = '';

            for (const status of ['0', '1', '2']) {
                const cards = cardsByStatus[status];
                if (!cards || cards.length === 0) continue;

                // Sort the cards before displaying
                const sortedCards = sortCards(cards);

                const sectionTitle = document.createElement('h2');
                sectionTitle.textContent = `${banNames[status]} (${sortedCards.length})`;
                sectionTitle.className = "font-bold text-lg pb-1";
                grid.appendChild(sectionTitle);

                const sectionGrid = document.createElement('div');
                sectionGrid.className = "grid grid-cols-5 md:grid-cols-7 lg:grid-cols-10 gap-1";
                grid.appendChild(sectionGrid);

                for (const card of sortedCards) {
                    const cardId = card.id;
                    const cardEl = await createCardElement(cardId, card);
                    sectionGrid.appendChild(cardEl);
                }
            }
        }

        async function imageExists(url) {
            try {
                const res = await fetch(url, { method: 'HEAD' });
                return res.ok;
            } catch {
                return false;
            }
        }

        async function createCardElement(cardId, cardData) {
            const mainCard = allCardsData[cardId] ?? altIdToMainCard[cardId] ?? cardData;
            const container = document.createElement('div');
            container.className = "relative rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center";

            const imgUrl = `./usedimages/${cardId}.jpg`;
            const exists = await imageExists(imgUrl);

            if (exists) {
                const img = document.createElement('img');
                img.src = imgUrl;
                img.alt = mainCard.name;
                img.title = mainCard.name;
                img.className = "rounded";
                container.appendChild(img);
            } else {
                const span = document.createElement('span');
                span.textContent = 'No Image';
                span.className = "text-xs text-gray-500 text-center";
                container.appendChild(span);
            }

            container.addEventListener('click', () => showCardDetails(mainCard, cardId));
            return container;
        }

        function showCardDetails(card, id) {
            const details = document.getElementById('cardDetails');
            details.innerHTML = `
        <h2 class="text-xl font-bold mb-2">${card.name}</h2>
        <div class="flex flex-col items-center lg:items-start lg:flex-row gap-4">
          <div class="w-2/3 lg:w-1/2">
            <img src="./usedimages/${id}.jpg" alt="${card.name}" class="mb-4 rounded shadow w-full lg:w-[12vw]" />
          </div>
          <div class="flex flex-col gap-2 lg:w-1/2">
            <p class="mb-2">[ ${card.typeline?.join(" / ") ?? card.type ?? 'Unknown Type'} ]</p>
            <p class="mb-2 whitespace-pre-wrap">${card.desc ?? 'No description'}</p>
            <p class="mb-2"><strong>Current ban:</strong> ${card.ban_tgc_current ?? 'N/A'}</p>
            <p class="mb-2"><strong>2014 ban:</strong> ${card.ban_tgc_2014 ?? 'N/A'}</p>
            ${card.ygoprodeck_url ? `<a href="${card.ygoprodeck_url}" target="_blank" class="text-blue-600 hover:underline">More info</a>` : ''}
          </div>
        </div>
      `;
        }

        async function main() {
            await loadAllCards();
            await loadBanlist();
        }

        main();
    </script>
</body>

</html>